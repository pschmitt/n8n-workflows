{
  "active": true,
  "activeVersion": {
    "updatedAt": "2026-02-11T19:21:03.000Z",
    "createdAt": "2026-02-11T19:20:25.540Z",
    "versionId": "956ec3e3-dc1f-4e9b-8845-db359ff3dd82",
    "workflowId": "19pwlUJok6EXe0uu",
    "nodes": [
      {
        "parameters": {},
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [
          -8192,
          1312
        ],
        "id": "f44f615d-81b5-4709-b127-2e1ab0dadc4d",
        "name": "When clicking ‘Execute workflow’"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\n\nconst globalData = $getWorkflowStaticData('global');\nif (!globalData.template_maps) {\n  globalData.template_maps = {};\n}\nif (!globalData.template_pending_sequence) {\n  globalData.template_pending_sequence = [];\n}\n\nlet templateMaps = globalData.template_maps;\nlet pendingSequence = globalData.template_pending_sequence;\n\nconst out = [];\n\nfor (const item of items) {\n  const data = { ...item.json };\n  if (data.action !== 'create_task') {\n    out.push({ json: data });\n    continue;\n  }\n\n  const payload = { ...(data.payload ?? {}) };\n  const runKey = payload.run_key;\n  const sessionId = payload.session_id;\n\n  if (sessionId && globalData.current_session_id !== sessionId) {\n    templateMaps = {};\n    pendingSequence = [];\n    globalData.template_maps = templateMaps;\n    globalData.template_pending_sequence = pendingSequence;\n    globalData.current_session_id = sessionId;\n  }\n\n  if (!runKey) {\n    out.push({ json: data });\n    continue;\n  }\n\n  if (payload.reset_template_map) {\n    templateMaps[runKey] = { [payload.root_template_id]: payload.root_task_id };\n  }\n\n  const mapping = templateMaps[runKey] ?? (templateMaps[runKey] = {});\n\n  if (payload.parent_id == null) {\n    const parentTemplateId = payload.parent_template_id;\n    if (mapping[parentTemplateId] == null) {\n      throw new Error(`Missing parent mapping for template ${parentTemplateId}`);\n    }\n    payload.parent_id = mapping[parentTemplateId];\n  }\n\n  pendingSequence.push({\n    run_key: runKey,\n    template_id: payload.template_id,\n    finalize_run: !!payload.finalize_run,\n  });\n\n  delete payload.reset_template_map;\n  data.payload = payload;\n  out.push({ json: data });\n}\n\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -6848,
          1296
        ],
        "name": "Assign Create Parent ID",
        "id": "5b3201f2-6735-49d5-ad26-1f2c771252be"
      },
      {
        "parameters": {
          "jsCode": "const items = $input.all();\n\nconst globalData = $getWorkflowStaticData('global');\nif (!globalData.template_maps) {\n  globalData.template_maps = {};\n}\nif (!globalData.template_pending_sequence) {\n  globalData.template_pending_sequence = [];\n}\n\nconst templateMaps = globalData.template_maps;\nconst pendingSequence = globalData.template_pending_sequence;\n\nconst out = [];\n\nfor (const item of items) {\n  if (!pendingSequence.length) {\n    throw new Error('No pending template metadata available for created task mapping');\n  }\n\n  const metadata = pendingSequence.shift();\n  const runKey = metadata.run_key;\n  const templateId = metadata.template_id;\n\n  if (runKey == null || templateId == null) {\n    out.push(item);\n    continue;\n  }\n\n  const mapping = templateMaps[runKey] ?? (templateMaps[runKey] = {});\n  mapping[templateId] = item.json.id;\n\n  if (metadata.finalize_run) {\n    delete templateMaps[runKey];\n    if (Object.keys(templateMaps).length === 0 && pendingSequence.length === 0) {\n      delete globalData.current_session_id;\n    }\n  }\n\n  out.push(item);\n}\n\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -6400,
          1360
        ],
        "name": "Record Created Task",
        "id": "e4ba41d5-75d4-4625-ade3-795da6da8b1d"
      },
      {
        "parameters": {
          "options": {}
        },
        "type": "n8n-nodes-base.splitInBatches",
        "typeVersion": 3,
        "position": [
          -7072,
          1360
        ],
        "name": "Process Create Batches",
        "id": "02d2bc9c-4132-48c8-abdd-60659a9f56ed"
      },
      {
        "parameters": {
          "operation": "getAll",
          "returnAll": true,
          "filters": {
            "labelId": "templated",
            "projectId": "2233792081"
          }
        },
        "type": "n8n-nodes-base.todoist",
        "typeVersion": 2.2,
        "position": [
          -7968,
          1072
        ],
        "id": "52b24987-d5a8-4559-a16b-4409be848b32",
        "name": "Get Test Project Tasks1",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "9be52dc4-7a8f-4ac9-b4e9-a84f1e66529d",
                "name": "__src",
                "value": "test",
                "type": "string"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -7840,
          1072
        ],
        "id": "dcd108f2-3e4d-4597-b970-399301b71ce4",
        "name": "Tag test tasks1"
      },
      {
        "parameters": {
          "operation": "getAll",
          "returnAll": true,
          "filters": {
            "projectId": "2360682540"
          }
        },
        "type": "n8n-nodes-base.todoist",
        "typeVersion": 2.2,
        "position": [
          -7968,
          1264
        ],
        "id": "a3f46e53-c925-4054-a59a-e612fb5ed00a",
        "name": "Get template tasks1",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "4d28c8ae-6821-4b4f-9668-2ff44cdfb1ff",
                "name": "__src",
                "value": "template",
                "type": "string"
              }
            ]
          },
          "includeOtherFields": true,
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -7840,
          1264
        ],
        "id": "dd41882e-e082-49d8-9747-901e2270189a",
        "name": "Tag template tasks1"
      },
      {
        "parameters": {},
        "type": "n8n-nodes-base.merge",
        "typeVersion": 3,
        "position": [
          -7744,
          1168
        ],
        "name": "Merge Tasks1",
        "id": "13134ff1-7374-403b-8d51-f51fa1d9668c"
      },
      {
        "parameters": {
          "language": "pythonNative",
          "pythonCode": "\nfrom collections import defaultdict\nfrom typing import Dict, List, Optional\nimport uuid\n\ndef normalize_name(value):\n    if not value:\n        return ''\n    # Strips leading emojis and spaces\n    first_alnum_index = -1\n    for i, char in enumerate(value):\n        if char.isalnum():\n            first_alnum_index = i\n            break\n    if first_alnum_index == -1:\n        return ''\n    value = value[first_alnum_index:]\n    # Remove all non-alphanumeric characters\n    return ''.join(ch for ch in value.lower() if ch.isalnum())\n\nitems = [item[\"json\"] for item in _items]\n\n# All tasks from the test project\ntest_project_tasks = [i for i in items if i.get(\"__src\") == \"test\"]\n# All tasks from the templates project\ntemplate_project_tasks = [i for i in items if i.get(\"__src\") == \"template\"]\n\ndef build_child_map(tasks: List[dict]) -> Dict[str, List[dict]]:\n    child_map: Dict[str, List[dict]] = defaultdict(list)\n    for task in tasks:\n        parent_id = task.get('parent_id')\n        if parent_id:\n            child_map[parent_id].append(task)\n    return child_map\n\ndef collect_descendants(task_id: str, child_map: Dict[str, List[dict]]):\n    stack = [(task_id, 0)]\n    descendants = []\n\n    while stack:\n        current_id, depth = stack.pop()\n        for child in child_map.get(current_id, []):\n            descendants.append((child, depth + 1))\n            stack.append((child['id'], depth + 1))\n\n    descendants.sort(key=lambda item: item[1], reverse=True)\n    return [task for task, _ in descendants]\n\ndef collect_template_payloads(\n    template_task: dict,\n    parent_actual_id: Optional[str],\n    run_key: str,\n    root_template_id: str,\n    root_task_id: str,\n    project_id: str,\n    session_id: str,\n):\n    payloads: List[dict] = []\n    for child in template_subtasks.get(template_task['id'], []):\n        payload = {\n            'content': child.get('content'),\n            'description': child.get('description'),\n            'priority': child.get('priority'),\n            'due': child.get('due', ''),\n            'labels': child.get('labels', []),\n            'parent_template_id': template_task['id'],\n            'template_id': child['id'],\n            'root_template_id': root_template_id,\n            'root_task_id': root_task_id,\n            'project_id': project_id,\n            'run_key': run_key,\n            'session_id': session_id,\n        }\n\n        if parent_actual_id is not None:\n            payload['parent_id'] = parent_actual_id\n\n        payloads.append(payload)\n        payloads.extend(\n            collect_template_payloads(\n                child,\n                None,\n                run_key,\n                root_template_id,\n                root_task_id,\n                project_id,\n                session_id,\n            )\n        )\n\n    return payloads\n\n# Build a map of parent_id -> list of child tasks for both projects\ntest_subtasks = build_child_map(test_project_tasks)\ntemplate_subtasks = build_child_map(template_project_tasks)\n\n# Create a lookup for top-level templates by their normalized name\ntemplate_lookup = {\n    normalize_name(t.get('content', '')): t\n    for t in template_project_tasks if not t.get('parent_id')\n}\n\nactions = []\nsession_id = uuid.uuid4().hex\n\n# Find tasks in the test project that need to be expanded\nfor task_to_expand in test_project_tasks:\n    if 'templated' in task_to_expand.get('labels', []):\n        normalized_content = normalize_name(task_to_expand.get('content', ''))\n        template = template_lookup.get(normalized_content)\n\n        if not template:\n            continue\n\n        # 1. Generate UPDATE action for the main task\n        original_labels = task_to_expand.get('labels', [])\n        template_labels = template.get('labels', [])\n        combined_labels = list(set(original_labels + template_labels))\n        final_labels = [label for label in combined_labels if label != 'templated']\n\n        update_payload = {\n            'task_id': task_to_expand['id'],\n            'project_id': task_to_expand['project_id'],\n            'content': template.get('content'),\n            'original_content': task_to_expand['content'],\n            'description': template.get('description'),\n            'priority': template.get('priority'),\n            'due': template.get('due', \"\"),\n            'labels': final_labels,\n        }\n        actions.append({'json': {'action': 'update_task', 'payload': update_payload}})\n\n        # 2. Generate DELETE actions for existing subtasks (all descendants)\n        existing_descendants = collect_descendants(task_to_expand['id'], test_subtasks)\n        for subtask in existing_descendants:\n            delete_payload = {'task_id': subtask['id']}\n            actions.append({'json': {'action': 'delete_task', 'payload': delete_payload}})\n\n        # 3. Generate CREATE actions for new subtasks from the template (all descendants)\n        run_key = f\"{task_to_expand['id']}::{template['id']}\"\n        create_payloads = collect_template_payloads(\n            template,\n            task_to_expand['id'],\n            run_key,\n            template['id'],\n            task_to_expand['id'],\n            task_to_expand.get('project_id'),\n            session_id,\n        )\n\n        if create_payloads:\n            create_payloads[0]['reset_template_map'] = True\n            create_payloads[-1]['finalize_run'] = True\n\n        for payload in create_payloads:\n            actions.append({'json': {'action': 'create_task', 'payload': payload}})\n\nreturn actions\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7520,
          1168
        ],
        "name": "Build Expansion Actions1",
        "id": "194efa2d-20e6-4bcf-a7db-c704cadd4e0f"
      },
      {
        "parameters": {
          "dataType": "string",
          "value1": "={{$json.action}}",
          "rules": {
            "rules": [
              {
                "value2": "update_task"
              },
              {
                "value2": "delete_task"
              },
              {
                "value2": "create_task"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 2,
        "position": [
          -7296,
          1152
        ],
        "name": "Route Action1",
        "id": "439720ea-7b78-43ff-86c7-641adda2a50a"
      },
      {
        "parameters": {
          "operation": "update",
          "taskId": "={{$json.payload.task_id}}",
          "updateFields": {
            "content": "={{$json.payload.content}}",
            "description": "={{$json.payload.description}}",
            "labels": "={{$json.payload.labels }}",
            "priority": "={{$json.payload.priority}}",
            "dueDate": "={{$json.payload.due ?? \"\"}}"
          }
        },
        "type": "n8n-nodes-base.todoist",
        "typeVersion": 2.2,
        "position": [
          -6832,
          960
        ],
        "name": "Update Task1",
        "id": "4550adc2-59b2-40e5-b260-e03dec0ba7a4",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      },
      {
        "parameters": {
          "operation": "delete",
          "taskId": "={{$json.payload.task_id}}"
        },
        "type": "n8n-nodes-base.todoist",
        "typeVersion": 2.2,
        "position": [
          -7072,
          1168
        ],
        "name": "Delete Task1",
        "id": "eb12ec90-1d5e-4b0b-8a86-f2776293c171",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      },
      {
        "parameters": {
          "project": {
            "__rl": true,
            "value": "={{$json.payload.project_id}}",
            "mode": "id"
          },
          "content": "={{$json.payload.content}}",
          "options": {
            "description": "={{$json.payload.description}}",
            "parentId": "={{$json.payload.parent_id}}",
            "priority": "={{$json.payload.priority}}"
          }
        },
        "type": "n8n-nodes-base.todoist",
        "typeVersion": 2.2,
        "position": [
          -6624,
          1296
        ],
        "name": "Create Task1",
        "id": "e2774ef5-8226-4eed-a1a4-a5c4e04a4408",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "02f2e06e-0dc6-472b-a4c4-691a8a3ced6f",
                "name": "id",
                "value": "={{ $json.body.event_data.id }}",
                "type": "string"
              },
              {
                "id": "9d362483-8501-4fb8-b7f2-cf7437c06024",
                "name": "content",
                "value": "={{ $json.body.event_data.content }}",
                "type": "string"
              },
              {
                "id": "a0e984ff-7805-4d5a-883f-0a94c18b6679",
                "name": "project_id",
                "value": "={{ $json.body.event_data.project_id }}",
                "type": "string"
              },
              {
                "id": "2a74b348-f6c5-46b9-9051-ea4912bc731d",
                "name": "labels",
                "value": "={{ $json.body.event_data.labels }}",
                "type": "array"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -8416,
          1024
        ],
        "id": "17470c95-1a10-4322-830e-ca6c32c810b6",
        "name": "Process webhook data"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "bba49f89-c616-4ccf-8c25-aa03916375e4",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -8640,
          1024
        ],
        "id": "3d6ab08f-fba8-4a7d-8530-fcaa053b37bc",
        "name": "Task added/updated",
        "webhookId": "ac02e75a-9cc7-4d93-ae4b-754efc4b72a7"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "68be4bbc-fbe4-4369-aa8e-6af3d8ef2d8d",
                "leftValue": "={{ $json.labels }}",
                "rightValue": "templated",
                "operator": {
                  "type": "array",
                  "operation": "contains",
                  "rightType": "any"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {
            "ignoreCase": true
          }
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -8192,
          1024
        ],
        "id": "a4da5e82-fe2f-470f-b911-44c668338628",
        "name": "Check task"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "=https://api.todoist.com/rest/v2/tasks/{{ $json.payload.task_id }}",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "todoistApi",
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={\n  \"labels\": [],\n  \"content\":  \"{{ $json.payload.content }}\",\n  \"description\": \"{{ $json.payload.description }}\",\n  \"priority\": {{ $json.payload.priority }},\n  \"due\": {{ $json.payload.due ?? \"null\" }}\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -7072,
          976
        ],
        "id": "d1cc77a9-a6a7-4d5c-827c-901950e477e1",
        "name": "HTTP Request",
        "credentials": {
          "todoistApi": {
            "id": "7jDBSQS5HIVX5LSR",
            "name": "Todoist account (API Key)"
          }
        }
      }
    ],
    "connections": {
      "When clicking ‘Execute workflow’": {
        "main": [
          [
            {
              "node": "Get Test Project Tasks1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Get template tasks1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Assign Create Parent ID": {
        "main": [
          [
            {
              "node": "Create Task1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process Create Batches": {
        "main": [
          [],
          [
            {
              "node": "Assign Create Parent ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Record Created Task": {
        "main": [
          [
            {
              "node": "Process Create Batches",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Test Project Tasks1": {
        "main": [
          [
            {
              "node": "Tag test tasks1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tag test tasks1": {
        "main": [
          [
            {
              "node": "Merge Tasks1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get template tasks1": {
        "main": [
          [
            {
              "node": "Tag template tasks1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Tag template tasks1": {
        "main": [
          [
            {
              "node": "Merge Tasks1",
              "type": "main",
              "index": 1
            }
          ]
        ]
      },
      "Merge Tasks1": {
        "main": [
          [
            {
              "node": "Build Expansion Actions1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Expansion Actions1": {
        "main": [
          [
            {
              "node": "Route Action1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Route Action1": {
        "main": [
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Delete Task1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Process Create Batches",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create Task1": {
        "main": [
          [
            {
              "node": "Record Created Task",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Process webhook data": {
        "main": [
          [
            {
              "node": "Check task",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Task added/updated": {
        "main": [
          [
            {
              "node": "Process webhook data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check task": {
        "main": [
          [
            {
              "node": "Get Test Project Tasks1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Get template tasks1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Philipp Schmitt",
    "name": "Version 956ec3e3",
    "description": "",
    "autosaved": true
  },
  "activeVersionId": "956ec3e3-dc1f-4e9b-8845-db359ff3dd82",
  "connections": {
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Get Test Project Tasks1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get template tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assign Create Parent ID": {
      "main": [
        [
          {
            "node": "Create Task1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Create Batches": {
      "main": [
        [],
        [
          {
            "node": "Assign Create Parent ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Created Task": {
      "main": [
        [
          {
            "node": "Process Create Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Test Project Tasks1": {
      "main": [
        [
          {
            "node": "Tag test tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tag test tasks1": {
      "main": [
        [
          {
            "node": "Merge Tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get template tasks1": {
      "main": [
        [
          {
            "node": "Tag template tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tag template tasks1": {
      "main": [
        [
          {
            "node": "Merge Tasks1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Tasks1": {
      "main": [
        [
          {
            "node": "Build Expansion Actions1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Expansion Actions1": {
      "main": [
        [
          {
            "node": "Route Action1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Action1": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Task1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Create Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Task1": {
      "main": [
        [
          {
            "node": "Record Created Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process webhook data": {
      "main": [
        [
          {
            "node": "Check task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Task added/updated": {
      "main": [
        [
          {
            "node": "Process webhook data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check task": {
      "main": [
        [
          {
            "node": "Get Test Project Tasks1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get template tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-26T19:31:19.369Z",
  "id": "19pwlUJok6EXe0uu",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "☑️ Todoist Template Expander",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -8192,
        1520
      ],
      "id": "f44f615d-81b5-4709-b127-2e1ab0dadc4d",
      "name": "When clicking ‘Execute workflow’"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst globalData = $getWorkflowStaticData('global');\nif (!globalData.template_maps) {\n  globalData.template_maps = {};\n}\nif (!globalData.template_pending_sequence) {\n  globalData.template_pending_sequence = [];\n}\n\nlet templateMaps = globalData.template_maps;\nlet pendingSequence = globalData.template_pending_sequence;\n\nconst out = [];\n\nfor (const item of items) {\n  const data = { ...item.json };\n  if (data.action !== 'create_task') {\n    out.push({ json: data });\n    continue;\n  }\n\n  const payload = { ...(data.payload ?? {}) };\n  const runKey = payload.run_key;\n  const sessionId = payload.session_id;\n\n  if (sessionId && globalData.current_session_id !== sessionId) {\n    templateMaps = {};\n    pendingSequence = [];\n    globalData.template_maps = templateMaps;\n    globalData.template_pending_sequence = pendingSequence;\n    globalData.current_session_id = sessionId;\n  }\n\n  if (!runKey) {\n    out.push({ json: data });\n    continue;\n  }\n\n  if (payload.reset_template_map) {\n    templateMaps[runKey] = { [payload.root_template_id]: payload.root_task_id };\n  }\n\n  const mapping = templateMaps[runKey] ?? (templateMaps[runKey] = {});\n\n  if (payload.parent_id == null) {\n    const parentTemplateId = payload.parent_template_id;\n    if (mapping[parentTemplateId] == null) {\n      throw new Error(`Missing parent mapping for template ${parentTemplateId}`);\n    }\n    payload.parent_id = mapping[parentTemplateId];\n  }\n\n  pendingSequence.push({\n    run_key: runKey,\n    template_id: payload.template_id,\n    finalize_run: !!payload.finalize_run,\n  });\n\n  delete payload.reset_template_map;\n  data.payload = payload;\n  out.push({ json: data });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6624,
        1496
      ],
      "name": "Assign Create Parent ID",
      "id": "5b3201f2-6735-49d5-ad26-1f2c771252be"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst globalData = $getWorkflowStaticData('global');\nif (!globalData.template_maps) {\n  globalData.template_maps = {};\n}\nif (!globalData.template_pending_sequence) {\n  globalData.template_pending_sequence = [];\n}\n\nconst templateMaps = globalData.template_maps;\nconst pendingSequence = globalData.template_pending_sequence;\n\nconst out = [];\n\nfor (const item of items) {\n  if (!pendingSequence.length) {\n    throw new Error('No pending template metadata available for created task mapping');\n  }\n\n  const metadata = pendingSequence.shift();\n  const runKey = metadata.run_key;\n  const templateId = metadata.template_id;\n\n  if (runKey == null || templateId == null) {\n    out.push(item);\n    continue;\n  }\n\n  const mapping = templateMaps[runKey] ?? (templateMaps[runKey] = {});\n  mapping[templateId] = item.json.id;\n\n  if (metadata.finalize_run) {\n    delete templateMaps[runKey];\n    if (Object.keys(templateMaps).length === 0 && pendingSequence.length === 0) {\n      delete globalData.current_session_id;\n    }\n  }\n\n  out.push(item);\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6176,
        1568
      ],
      "name": "Record Created Task",
      "id": "e4ba41d5-75d4-4625-ade3-795da6da8b1d"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -6848,
        1568
      ],
      "name": "Process Create Batches",
      "id": "02d2bc9c-4132-48c8-abdd-60659a9f56ed"
    },
    {
      "parameters": {
        "operation": "getAll",
        "returnAll": true,
        "filters": {
          "labelId": "templated",
          "projectId": "6cxWC8m6pfCgHVCg"
        }
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.2,
      "position": [
        -7968,
        1280
      ],
      "id": "52b24987-d5a8-4559-a16b-4409be848b32",
      "name": "Get Test Project Tasks1",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9be52dc4-7a8f-4ac9-b4e9-a84f1e66529d",
              "name": "__src",
              "value": "test",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7744,
        1280
      ],
      "id": "dcd108f2-3e4d-4597-b970-399301b71ce4",
      "name": "Tag test tasks1"
    },
    {
      "parameters": {
        "operation": "getAll",
        "returnAll": true,
        "filters": {
          "projectId": "6cxWC8m6pfCgHVCg"
        }
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.2,
      "position": [
        -7968,
        1472
      ],
      "id": "a3f46e53-c925-4054-a59a-e612fb5ed00a",
      "name": "Get template tasks1",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4d28c8ae-6821-4b4f-9668-2ff44cdfb1ff",
              "name": "__src",
              "value": "template",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7744,
        1472
      ],
      "id": "dd41882e-e082-49d8-9747-901e2270189a",
      "name": "Tag template tasks1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -7520,
        1376
      ],
      "name": "Merge Tasks1",
      "id": "13134ff1-7374-403b-8d51-f51fa1d9668c"
    },
    {
      "parameters": {
        "language": "pythonNative",
        "pythonCode": "\nfrom collections import defaultdict\nfrom typing import Dict, List, Optional\nimport uuid\n\ndef normalize_name(value):\n    if not value:\n        return ''\n    # Strips leading emojis and spaces\n    first_alnum_index = -1\n    for i, char in enumerate(value):\n        if char.isalnum():\n            first_alnum_index = i\n            break\n    if first_alnum_index == -1:\n        return ''\n    value = value[first_alnum_index:]\n    # Remove all non-alphanumeric characters\n    return ''.join(ch for ch in value.lower() if ch.isalnum())\n\nitems = [item[\"json\"] for item in _items]\n\n# All tasks from the test project\ntest_project_tasks = [i for i in items if i.get(\"__src\") == \"test\"]\n# All tasks from the templates project\ntemplate_project_tasks = [i for i in items if i.get(\"__src\") == \"template\"]\n\ndef build_child_map(tasks: List[dict]) -> Dict[str, List[dict]]:\n    child_map: Dict[str, List[dict]] = defaultdict(list)\n    for task in tasks:\n        parent_id = task.get('parent_id')\n        if parent_id:\n            child_map[parent_id].append(task)\n    return child_map\n\ndef collect_descendants(task_id: str, child_map: Dict[str, List[dict]]):\n    stack = [(task_id, 0)]\n    descendants = []\n\n    while stack:\n        current_id, depth = stack.pop()\n        for child in child_map.get(current_id, []):\n            descendants.append((child, depth + 1))\n            stack.append((child['id'], depth + 1))\n\n    descendants.sort(key=lambda item: item[1], reverse=True)\n    return [task for task, _ in descendants]\n\ndef collect_template_payloads(\n    template_task: dict,\n    parent_actual_id: Optional[str],\n    run_key: str,\n    root_template_id: str,\n    root_task_id: str,\n    project_id: str,\n    session_id: str,\n):\n    payloads: List[dict] = []\n    for child in template_subtasks.get(template_task['id'], []):\n        payload = {\n            'content': child.get('content'),\n            'description': child.get('description'),\n            'priority': child.get('priority'),\n            'due': child.get('due', ''),\n            'labels': child.get('labels', []),\n            'parent_template_id': template_task['id'],\n            'template_id': child['id'],\n            'root_template_id': root_template_id,\n            'root_task_id': root_task_id,\n            'project_id': project_id,\n            'run_key': run_key,\n            'session_id': session_id,\n        }\n\n        if parent_actual_id is not None:\n            payload['parent_id'] = parent_actual_id\n\n        payloads.append(payload)\n        payloads.extend(\n            collect_template_payloads(\n                child,\n                None,\n                run_key,\n                root_template_id,\n                root_task_id,\n                project_id,\n                session_id,\n            )\n        )\n\n    return payloads\n\n# Build a map of parent_id -> list of child tasks for both projects\ntest_subtasks = build_child_map(test_project_tasks)\ntemplate_subtasks = build_child_map(template_project_tasks)\n\n# Create a lookup for top-level templates by their normalized name\ntemplate_lookup = {\n    normalize_name(t.get('content', '')): t\n    for t in template_project_tasks if not t.get('parent_id')\n}\n\nactions = []\nsession_id = uuid.uuid4().hex\n\n# Find tasks in the test project that need to be expanded\nfor task_to_expand in test_project_tasks:\n    if 'templated' in task_to_expand.get('labels', []):\n        normalized_content = normalize_name(task_to_expand.get('content', ''))\n        template = template_lookup.get(normalized_content)\n\n        if not template:\n            continue\n\n        # 1. Generate UPDATE action for the main task\n        original_labels = task_to_expand.get('labels', [])\n        template_labels = template.get('labels', [])\n        combined_labels = list(set(original_labels + template_labels))\n        final_labels = [label for label in combined_labels if label != 'templated']\n\n        update_payload = {\n            'task_id': task_to_expand['id'],\n            'project_id': task_to_expand['project_id'],\n            'content': template.get('content'),\n            'original_content': task_to_expand['content'],\n            'description': template.get('description'),\n            'priority': template.get('priority'),\n            'due': template.get('due', \"\"),\n            'labels': final_labels,\n        }\n        actions.append({'json': {'action': 'update_task', 'payload': update_payload}})\n\n        # 2. Generate DELETE actions for existing subtasks (all descendants)\n        existing_descendants = collect_descendants(task_to_expand['id'], test_subtasks)\n        for subtask in existing_descendants:\n            delete_payload = {'task_id': subtask['id']}\n            actions.append({'json': {'action': 'delete_task', 'payload': delete_payload}})\n\n        # 3. Generate CREATE actions for new subtasks from the template (all descendants)\n        run_key = f\"{task_to_expand['id']}::{template['id']}\"\n        create_payloads = collect_template_payloads(\n            template,\n            task_to_expand['id'],\n            run_key,\n            template['id'],\n            task_to_expand['id'],\n            task_to_expand.get('project_id'),\n            session_id,\n        )\n\n        if create_payloads:\n            create_payloads[0]['reset_template_map'] = True\n            create_payloads[-1]['finalize_run'] = True\n\n        for payload in create_payloads:\n            actions.append({'json': {'action': 'create_task', 'payload': payload}})\n\nreturn actions\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7296,
        1376
      ],
      "name": "Build Expansion Actions1",
      "id": "194efa2d-20e6-4bcf-a7db-c704cadd4e0f"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.action}}",
        "rules": {
          "rules": [
            {
              "value2": "update_task"
            },
            {
              "value2": "delete_task"
            },
            {
              "value2": "create_task"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        -7072,
        1360
      ],
      "name": "Route Action1",
      "id": "439720ea-7b78-43ff-86c7-641adda2a50a"
    },
    {
      "parameters": {
        "operation": "update",
        "taskId": "={{$json.payload.task_id}}",
        "updateFields": {
          "content": "={{$json.payload.content}}",
          "description": "={{$json.payload.description}}",
          "labels": "={{$json.payload.labels }}",
          "priority": "={{$json.payload.priority}}",
          "dueDate": "={{$json.payload.due ?? \"\"}}"
        }
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.2,
      "position": [
        -8640,
        960
      ],
      "name": "Update Task1",
      "id": "4550adc2-59b2-40e5-b260-e03dec0ba7a4",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "taskId": "={{$json.payload.task_id}}"
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.2,
      "position": [
        -6848,
        1376
      ],
      "name": "Delete Task1",
      "id": "eb12ec90-1d5e-4b0b-8a86-f2776293c171",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    },
    {
      "parameters": {
        "project": {
          "__rl": true,
          "value": "={{$json.payload.project_id}}",
          "mode": "id"
        },
        "content": "={{$json.payload.content}}",
        "options": {
          "description": "={{$json.payload.description}}",
          "parentId": "={{$json.payload.parent_id}}",
          "priority": "={{$json.payload.priority}}"
        }
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.2,
      "position": [
        -6400,
        1496
      ],
      "name": "Create Task1",
      "id": "e2774ef5-8226-4eed-a1a4-a5c4e04a4408",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "02f2e06e-0dc6-472b-a4c4-691a8a3ced6f",
              "name": "id",
              "value": "={{ $json.body.event_data.id }}",
              "type": "string"
            },
            {
              "id": "9d362483-8501-4fb8-b7f2-cf7437c06024",
              "name": "content",
              "value": "={{ $json.body.event_data.content }}",
              "type": "string"
            },
            {
              "id": "a0e984ff-7805-4d5a-883f-0a94c18b6679",
              "name": "project_id",
              "value": "={{ $json.body.event_data.project_id }}",
              "type": "string"
            },
            {
              "id": "2a74b348-f6c5-46b9-9051-ea4912bc731d",
              "name": "labels",
              "value": "={{ $json.body.event_data.labels }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8416,
        1232
      ],
      "id": "17470c95-1a10-4322-830e-ca6c32c810b6",
      "name": "Process webhook data"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bba49f89-c616-4ccf-8c25-aa03916375e4",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -8640,
        1232
      ],
      "id": "3d6ab08f-fba8-4a7d-8530-fcaa053b37bc",
      "name": "Task added/updated",
      "webhookId": "ac02e75a-9cc7-4d93-ae4b-754efc4b72a7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "68be4bbc-fbe4-4369-aa8e-6af3d8ef2d8d",
              "leftValue": "={{ $json.labels }}",
              "rightValue": "templated",
              "operator": {
                "type": "array",
                "operation": "contains",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8192,
        1232
      ],
      "id": "a4da5e82-fe2f-470f-b911-44c668338628",
      "name": "Check task"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.todoist.com/rest/v2/tasks/{{ $json.payload.task_id }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "todoistApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"labels\": [],\n  \"content\":  \"{{ $json.payload.content }}\",\n  \"description\": \"{{ $json.payload.description }}\",\n  \"priority\": {{ $json.payload.priority }},\n  \"due\": {{ $json.payload.due ?? \"null\" }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -6848,
        1184
      ],
      "id": "d1cc77a9-a6a7-4d5c-827c-901950e477e1",
      "name": "HTTP Request",
      "credentials": {
        "todoistApi": {
          "id": "7jDBSQS5HIVX5LSR",
          "name": "Todoist account (API Key)"
        }
      }
    }
  ],
  "pinData": {
    "Task added/updated": [
      {
        "json": {
          "headers": {
            "connection": "close",
            "host": "n8n.brkn.lol",
            "x-real-ip": "52.90.116.203",
            "x-forwarded-for": "52.90.116.203",
            "x-forwarded-proto": "https",
            "x-forwarded-host": "n8n.brkn.lol",
            "x-forwarded-server": "rofl-10",
            "content-length": "852",
            "user-agent": "Todoist-Webhooks",
            "content-type": "application/json",
            "x-todoist-hmac-sha256": "Oge6gVdPedJTz45IJXBr0x5lPoc5+MgcB9pUyM1aY8M=",
            "x-todoist-delivery-id": "6308e301-c5d7-43fd-8a03-118514a8836c",
            "x-app-id": "40200",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "event_data": {
              "added_at": "2026-02-11T19:28:11.048588Z",
              "added_by_uid": "1087845",
              "assigned_by_uid": null,
              "checked": false,
              "child_order": 1,
              "completed_at": null,
              "completed_by_uid": null,
              "content": "Packing",
              "day_order": -1,
              "deadline": null,
              "description": "",
              "due": null,
              "duration": null,
              "id": "6fxqh3mHH2jrJX2p",
              "is_collapsed": false,
              "is_deleted": false,
              "labels": [
                "templated"
              ],
              "note_count": 0,
              "parent_id": null,
              "priority": 1,
              "project_id": "6Crcx5cJvmr22H3G",
              "responsible_uid": null,
              "section_id": null,
              "updated_at": "2026-02-11T19:28:11.048605Z",
              "url": "https://app.todoist.com/app/task/6fxqh3mHH2jrJX2p",
              "user_id": "1087845"
            },
            "event_name": "item:added",
            "initiator": {
              "email": "philipp@schmitt.co",
              "full_name": "pschmitt",
              "id": "1087845",
              "image_id": "02854bc8a8f64adfa0cc079a40de52b7",
              "is_premium": true
            },
            "triggered_at": "2026-02-11T19:28:11.345422Z",
            "user_id": "1087845",
            "version": "1"
          },
          "webhookUrl": "https://n8n.brkn.lol/webhook/bba49f89-c616-4ccf-8c25-aa03916375e4",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "repo_name": "n8n-workflows",
  "repo_owner": "pschmitt",
  "repo_path": "workflows",
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true
  },
  "shared": [
    {
      "updatedAt": "2025-09-26T19:31:19.374Z",
      "createdAt": "2025-09-26T19:31:19.374Z",
      "role": "workflow:owner",
      "workflowId": "19pwlUJok6EXe0uu",
      "projectId": "DeJsGrmui3Dbhpxg"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    },
    "global": {
      "template_maps": {},
      "template_pending_sequence": []
    }
  },
  "tags": [
    {
      "updatedAt": "2025-03-01T06:50:52.672Z",
      "createdAt": "2025-03-01T06:50:52.672Z",
      "id": "mjfF2OqntfnQP15x",
      "name": "todoist"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2026-02-11T19:29:04.227Z",
  "versionId": "c6a0f09d-66bc-4320-a586-dedb6784148d"
}