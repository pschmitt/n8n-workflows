{
  "active": false,
  "connections": {
    "When clicking ‚ÄòTest workflow‚Äô": {
      "main": [
        [
          {
            "node": "Fetch Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Fetch Projects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Projects": {
      "main": [
        [
          {
            "node": "Select Templates Project",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Templates Project": {
      "main": [
        [
          {
            "node": "Fetch Template Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Template Tasks": {
      "main": [
        [
          {
            "node": "Fetch Active Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Active Tasks": {
      "main": [
        [
          {
            "node": "Build Template Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Template Actions": {
      "main": [
        [
          {
            "node": "Route Template Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Template Actions": {
      "main": [
        [
          {
            "node": "Prepare Template Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Create Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Template Context": {
      "main": [
        [
          {
            "node": "Delete Placeholder Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Create Payload": {
      "main": [
        [
          {
            "node": "Create Template Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Template Task": {
      "main": [
        [
          {
            "node": "Update Parent Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-26T19:31:19.369Z",
  "id": "19pwlUJok6EXe0uu",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "‚òëÔ∏è Todoist Template Expander",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1808,
        480
      ],
      "name": "When clicking ‚ÄòTest workflow‚Äô",
      "id": "df0d5165-ab32-48f5-af77-831352b4c644"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1808,
        672
      ],
      "name": "Schedule Trigger",
      "id": "29ddf615-47bd-4eea-8cb0-1b064629d3cc"
    },
    {
      "parameters": {
        "content": "## Todoist Template Expander\n\nReplaces shorthand tasks (`!!X`) by cloning from Templates project.",
        "height": 260,
        "width": 360
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1940,
        380
      ],
      "name": "Sticky Note",
      "id": "82d50695-65fb-4933-b8ca-d7985eaf5605"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "project",
        "operation": "getAll"
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.1,
      "position": [
        -1584,
        576
      ],
      "name": "Fetch Projects",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "id": "92269b1c-1481-4bba-8062-5c70dffb3c1b",
      "credentials": {
        "todoistOAuth2Api": {
          "id": "pRLGe9rI6m8eY5MJ",
          "name": "Todoist account (OAuth)"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "def normalize_name(v):\n  return ''.join(ch for ch in (v or '').lower() if ch.isalnum())\nprojects=[i.json for i in _input.all()]\nfor p in projects:\n  if normalize_name(p.get('name',''))=='templates':\n    return [{'json':{'templatesProjectId':p.get('id'),'templatesProject':p}}]\nreturn []"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1360,
        576
      ],
      "name": "Select Templates Project",
      "id": "749902c0-4a8d-43c0-bad1-569cbc87ee1f"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "getAll",
        "returnAll": true,
        "filters": {
          "projectId": "={{$json.templatesProjectId}}"
        }
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.1,
      "position": [
        -1136,
        576
      ],
      "name": "Fetch Template Tasks",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "id": "e5e8f02f-721c-45fc-8ee4-8d2c2ba4672e",
      "credentials": {
        "todoistOAuth2Api": {
          "id": "pRLGe9rI6m8eY5MJ",
          "name": "Todoist account (OAuth)"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "getAll",
        "returnAll": true,
        "filters": {}
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.1,
      "position": [
        -912,
        576
      ],
      "name": "Fetch Active Tasks",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "id": "e9329433-72db-4a93-b025-3075fe28cb87",
      "credentials": {
        "todoistOAuth2Api": {
          "id": "pRLGe9rI6m8eY5MJ",
          "name": "Todoist account (OAuth)"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "import re,collections\nDEBUG=False\nLIMIT_TO_TEST_PROJECT=True\nTEST='üß™ Test (meta)'\nnormalize=lambda v:'' if not v else ''.join(c for c in v.lower() if c.isalnum())\nsel=_('Select Templates Project').first()\nif not sel: return []\ntid=sel.json.get('templatesProjectId')\nif not tid: return []\nT=[i.json for i in _('Fetch Template Tasks').all()]\nif not T: return []\nprojects=[i.json for i in _('Fetch Projects').all()]\nallowed=set()\nif LIMIT_TO_TEST_PROJECT:\n  for p in projects:\n    if (p.get('name') or '').strip()==TEST: allowed.add(p.get('id'))\nelse:\n  allowed={p.get('id') for p in projects if p.get('id')!=tid}\nchildren=collections.defaultdict(list)\nfor t in T:\n  if t.get('parent_id'): children[t['parent_id']].append(t)\nfor s in children.values(): s.sort(key=lambda x:x.get('child_order',0))\nindex=[(t,normalize(t.get('content',''))) for t in T]\npat=re.compile(r'^!!\\s*(.+)$',re.I)\nout=[]\nfor t in [i.json for i in _input.all()]:\n  pid=t.get('project_id')\n  if pid==tid or (allowed and pid not in allowed): continue\n  m=pat.match(t.get('content','') or '')\n  if not m: continue\n  name=m.group(1).strip(); key=normalize(name)\n  c=[tt for tt,n in index if n==key]\n  c.sort(key=lambda tt:(tt.get('parent_id') is not None,tt.get('child_order',0)))\n  if not c: continue\n  root=c[0]\n  dq=collections.deque([root]);sub=[]\n  while dq:\n    cur=dq.popleft();sub.append(cur)\n    for ch in children.get(cur.get('id'),[]):dq.append(ch)\n  if not sub: continue\n  ph={'id':t.get('id'),'projectId':pid,'sectionId':t.get('section_id'),'parentId':t.get('parent_id'),'order':t.get('order'),'childOrder':t.get('child_order')}\n  phk=str(t.get('id'))\n  out.append({'json':{'action':'deletePlaceholder','placeholder':ph,'placeholderKey':phk,'totalCreateActions':len(sub)}})\n  for i,s in enumerate(sub):\n    out.append({'json':{'action':'createFromTemplate','placeholder':ph,'placeholderKey':phk,'task':{'templateId':s.get('id'),'parentTemplateId':s.get('parent_id'),'content':s.get('content',''),'description':s.get('description') or '','priority':s.get('priority'),'labels':s.get('labels') or [],'order':s.get('order'),'childOrder':s.get('child_order'),'due':s.get('due') or {},'isRoot':s.get('id')==root.get('id')},'isLastAction':i==len(sub)-1}})\nreturn out"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        576
      ],
      "name": "Build Template Actions",
      "id": "aaf97f2c-c3f9-49de-b678-6081b1588ec0"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.action}}",
        "rules": {
          "rules": [
            {
              "value2": "deletePlaceholder"
            },
            {
              "value2": "createFromTemplate"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        -464,
        576
      ],
      "name": "Route Template Actions",
      "id": "c82bfec6-d766-4bc8-b509-5175900f4580"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "def get_static_data():\n  return _getWorkflowStaticData('node')\n\ndata=get_static_data()\nit=_input.all()[0].json\nph=it.get('placeholder');k=str(it.get('placeholderKey') or ph.get('id'))\nctxs=data.get('contexts') or {}\nctxs[k]={'placeholder':ph,'parentMap':{},'remainingCreates':it.get('totalCreateActions',0),'pendingTemplateIds':[]}\ndata['contexts']=ctxs;data['currentPlaceholderKey']=k\nreturn _input.all()"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        480
      ],
      "name": "Prepare Template Context",
      "id": "4ac2ce27-0432-4fd2-a0fe-17657547ffd6"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "delete",
        "taskId": "={{$json.placeholder.id}}"
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.1,
      "position": [
        -16,
        480
      ],
      "name": "Delete Placeholder Task",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "id": "116ddc0d-2d90-48a0-af9a-a8b46b5a9505",
      "credentials": {
        "todoistOAuth2Api": {
          "id": "pRLGe9rI6m8eY5MJ",
          "name": "Todoist account (OAuth)"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "data=_getWorkflowStaticData('node')\nit=_input.all()[0].json\nk=str(it.get('placeholderKey'))\nctxs=data.get('contexts') or {}\nctx=ctxs.get(k) or {'placeholder':it.get('placeholder') or {},'parentMap':{},'remainingCreates':it.get('totalCreateActions',0),'pendingTemplateIds':[]}\nph=ctx['placeholder'];pm=ctx['parentMap'];pending=ctx.get('pendingTemplateIds',[])\nt=it['task']\nopts={}\nif t.get('description'):opts['description']=t['description']\nif t.get('priority'):opts['priority']=t['priority']\nif t.get('isRoot'):\n  if ph.get('sectionId'):opts['section']=ph['sectionId']\n  if ph.get('parentId'):opts['parentId']=ph['parentId']\nelse:\n  pid=t.get('parentTemplateId')\n  if pid and pid in pm:opts['parentId']=pm[pid]\npending.append(t['templateId']);ctx['pendingTemplateIds']=pending\nctxs[k]=ctx;data['contexts']=ctxs\nreturn [{'json':{'placeholderKey':k,'placeholder':ph,'task':t,'create':{'content':t.get('content'), 'project':ph.get('projectId'), 'labels':t.get('labels',[]),'options':opts,'templateId':t.get('templateId'),'placeholderKey':k,'isLastAction':it.get('isLastAction')}}}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        672
      ],
      "name": "Prepare Create Payload",
      "id": "6b6db0f4-4201-465d-b7a1-67b1ba4fbc59"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "project": "={{$json.create.project}}",
        "labels": "={{$json.create.labels}}",
        "content": "={{$json.create.content}}",
        "options": {}
      },
      "type": "n8n-nodes-base.todoist",
      "typeVersion": 2.1,
      "position": [
        -16,
        672
      ],
      "name": "Create Template Task",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "id": "2ddfa31c-de40-4934-ac2a-2c1fae4d10ef",
      "credentials": {
        "todoistOAuth2Api": {
          "id": "pRLGe9rI6m8eY5MJ",
          "name": "Todoist account (OAuth)"
        }
      }
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "# Update Parent Map ‚Äî JsProxy-safe, handles dict/list/sequence payloads and batches\n\ndef is_string_like(x):\n  return isinstance(x, (str, bytes, bytearray))\n\ndef is_mapping_like(x):\n  # Works for dict and JsProxy objects that behave like a mapping\n  if isinstance(x, dict):\n    return True\n  return hasattr(x, \"keys\") or hasattr(x, \"items\")\n\ndef is_sequence_like(x):\n  # Works for list/tuple and JsProxy arrays\n  if isinstance(x, (list, tuple)):\n    return True\n  if is_string_like(x):\n    return False\n  return hasattr(x, \"__len__\") and hasattr(x, \"__getitem__\")\n\ndef mget(obj, key, default=None):\n  \"\"\"Mapping get for dict/JsProxy mapping.\"\"\"\n  if isinstance(obj, dict):\n    return obj.get(key, default)\n  # JsProxy mapping: try key lookup\n  try:\n    val = obj[key]\n    return val\n  except Exception:\n    pass\n  # Try attribute (last resort)\n  try:\n    return getattr(obj, key)\n  except Exception:\n    return default\n\ndef iter_values(obj):\n  \"\"\"Yield values of a mapping-like object.\"\"\"\n  if isinstance(obj, dict):\n    for v in obj.values():\n      yield v\n    return\n  # JsProxy: try .values(), then items()\n  try:\n    vals = obj.values()  # may exist on JsProxy\n    for v in vals:\n      yield v\n    return\n  except Exception:\n    pass\n  try:\n    for _, v in obj.items():\n      yield v\n    return\n  except Exception:\n    pass\n  # Fallback: try keys()\n  try:\n    for k in obj.keys():\n      yield mget(obj, k)\n  except Exception:\n    return\n\ndef iter_task_ids(payload):\n  \"\"\"\n  Yield Todoist task IDs from any payload:\n  - dict/JsProxy mapping with 'id'\n  - list/tuple/JsProxy array of such dicts\n  - nested under 'data' / 'task' / 'json'\n  \"\"\"\n  # Unwrap n8n items\n  if hasattr(payload, \"json\"):\n    payload = payload.json\n\n  # Mapping-like\n  if is_mapping_like(payload):\n    tid = mget(payload, \"id\")\n    if tid:\n      yield tid\n      return\n    # common wrappers\n    for k in (\"data\", \"task\", \"json\"):\n      inner = mget(payload, k)\n      if inner is not None:\n        for x in iter_task_ids(inner):\n          yield x\n        # do not return; allow other wrappers too\n    # fallback: walk values\n    for v in iter_values(payload):\n      for x in iter_task_ids(v):\n        yield x\n    return\n\n  # Sequence-like (incl. JsProxy arrays)\n  if is_sequence_like(payload):\n    try:\n      n = len(payload)\n    except Exception:\n      n = 0\n    for i in range(n):\n      try:\n        v = payload[i]\n      except Exception:\n        continue\n      for x in iter_task_ids(v):\n        yield x\n    return\n\n  # nothing found\n  return\n\ndef to_str(v):\n  return None if v is None else str(v)\n\ndef get_static():\n  return _getWorkflowStaticData(\"node\")  # type: ignore[name-defined]\n\ndata = get_static()\ncontexts = data.get(\"contexts\") or {}\ncurrent_key = to_str(data.get(\"currentPlaceholderKey\"))\n\nout_items = []\n\n# Process all create results (there can be multiple)\nfor item in _input.all():\n  # Extract ALL ids from the payload (handles list/dict/JsProxy)\n  created_ids = list(iter_task_ids(item))\n  if not created_ids:\n    # Try the raw json as a fallback (in case the input wrapper differs)\n    created_ids = list(iter_task_ids(getattr(item, \"json\", None)))\n  if not created_ids:\n    raise ValueError(\"Failed to determine created task id\")\n\n  # Decide which placeholder context to use\n  placeholder_key = current_key\n  if placeholder_key is None:\n    j = getattr(item, \"json\", None)\n    if is_mapping_like(j):\n      placeholder_key = to_str(mget(j, \"placeholderKey\"))\n  if placeholder_key is None:\n    raise ValueError(\"Missing placeholder key when updating parent map\")\n\n  ctx = contexts.get(placeholder_key)\n  if ctx is None:\n    # Defensive bootstrap (usually exists already)\n    ctx = {\n      \"placeholder\": {},\n      \"parentMap\": {},\n      \"remainingCreates\": 0,\n      \"pendingTemplateIds\": [],\n    }\n\n  parent_map = ctx.get(\"parentMap\") or {}\n  pending = list(ctx.get(\"pendingTemplateIds\") or [])\n\n  # Map each new id to the next pending templateId (FIFO)\n  for new_id in created_ids:\n    if pending:\n      templ_id = pending.pop(0)\n    else:\n      # Rare fallback: try echo\n      templ_id = None\n      j = getattr(item, \"json\", None)\n      if is_mapping_like(j):\n        task_payload = mget(j, \"task\", {})\n        if is_mapping_like(task_payload):\n          templ_id = mget(task_payload, \"templateId\")\n    if templ_id is None:\n      raise ValueError(\"Missing template id for created task (pending queue empty)\")\n    parent_map[templ_id] = new_id\n\n  # Save updates\n  ctx[\"parentMap\"] = parent_map\n  ctx[\"pendingTemplateIds\"] = pending\n\n  # Decrement remainingCreates by the number we just mapped (usually 1)\n  rem = ctx.get(\"remainingCreates\")\n  if isinstance(rem, int) and rem > 0:\n    ctx[\"remainingCreates\"] = max(0, rem - len(created_ids))\n\n  # Decide if we've finished this placeholder\n  is_last = ctx.get(\"remainingCreates\") in (None, 0)\n  j = getattr(item, \"json\", None)\n  if is_mapping_like(j) and mget(j, \"isLastAction\"):\n    is_last = True\n\n  if is_last:\n    contexts.pop(placeholder_key, None)\n    if to_str(data.get(\"currentPlaceholderKey\")) == placeholder_key:\n      data[\"currentPlaceholderKey\"] = None\n    # Let the next placeholder set its key\n    current_key = None\n  else:\n    contexts[placeholder_key] = ctx\n\n  # Pass-through for downstream logging if needed\n  out_items.append({\"json\": getattr(item, \"json\", {}) or {}})\n\n# Persist back\ndata[\"contexts\"] = contexts if contexts else {}\nif not contexts:\n  data[\"currentPlaceholderKey\"] = None\n\nreturn out_items\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        672
      ],
      "name": "Update Parent Map",
      "id": "5ada9acb-5e71-4a1d-8c1a-0826f5ed1e5c"
    }
  ],
  "pinData": {},
  "repo_name": "n8n-workflows",
  "repo_owner": "pschmitt",
  "repo_path": "workflows",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-09-26T19:31:19.374Z",
      "updatedAt": "2025-09-26T19:31:19.374Z",
      "role": "workflow:owner",
      "workflowId": "19pwlUJok6EXe0uu",
      "projectId": "DeJsGrmui3Dbhpxg"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "createdAt": "2025-03-01T06:50:52.672Z",
      "updatedAt": "2025-03-01T06:50:52.672Z",
      "id": "mjfF2OqntfnQP15x",
      "name": "todoist"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-09-28T12:31:54.000Z",
  "versionId": "e83bf0a2-6e4a-44ea-857a-98c86747af19"
}